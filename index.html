<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Selector y Paleta de Colores</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f7fa;
    margin: 20px;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    color: #2c3e50;
  }
  #instructions {
    max-width: 600px;
    background: #e8f0fe;
    border: 1px solid #a8c0ff;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 25px;
    font-size: 1rem;
    line-height: 1.4;
  }
  #upload-label {
    cursor: pointer;
    background: #4a90e2;
    color: white;
    padding: 12px 24px;
    border-radius: 30px;
    font-weight: 600;
    transition: background 0.3s ease;
    display: inline-block;
    margin-bottom: 25px;
  }
  #upload-label:hover {
    background: #357ABD;
  }
  #upload {
    display: none;
  }
  #container {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
    justify-content: center;
  }
  #image-container {
    position: relative;
    max-width: 500px;
    max-height: 500px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.1);
    border-radius: 12px;
    overflow: hidden;
    cursor: crosshair;
    background: white;
  }
  #canvas {
    width: 100%;
    height: auto;
    display: block;
  }
  #color-info {
    max-width: 300px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.1);
  }
  #picked-color {
    width: 100%;
    height: 80px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 2px solid #ccc;
  }
  .color-code {
    font-family: monospace;
    font-size: 1.1rem;
    margin: 5px 0;
  }
  #palette {
    display: flex;
    gap: 12px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .palette-color {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    border: 2px solid #fff;
    cursor: default;
  }
  .palette-color:hover {
    border-color: #4a90e2;
  }
  footer {
    margin-top: 40px;
    font-size: 0.85rem;
    color: #777;
  }
</style>
</head>
<body>

<h1>Selector y Paleta de Colores</h1>

<div id="instructions">
  <strong>Instrucciones:</strong>
  <ol>
    <li>Haz clic en "Subir imagen" y selecciona una imagen desde tu dispositivo.</li>
    <li>La imagen aparecerá abajo. Haz clic sobre cualquier parte de la imagen para obtener el color exacto de ese punto.</li>
    <li>Verás el código de color en formatos HEX, RGB y HSL, junto con una muestra visual.</li>
    <li>Debajo, se muestra la paleta con los 5 colores principales extraídos automáticamente de la imagen.</li>
  </ol>
</div>

<label id="upload-label" for="upload">Subir imagen</label>
<input type="file" id="upload" accept="image/*" />

<div id="container">
  <div id="image-container" style="display:none;">
    <canvas id="canvas"></canvas>
    <img id="image" alt="Imagen subida" style="display:none;" crossorigin="anonymous" />
  </div>
  
  <div id="color-info" style="display:none;">
    <div id="picked-color"></div>
    <div class="color-code" id="hex"></div>
    <div class="color-code" id="rgb"></div>
    <div class="color-code" id="hsl"></div>
    <h3>Paleta principal</h3>
    <div id="palette"></div>
  </div>
</div>

<footer>
  &copy; 2025 - Herramienta de selección de color
</footer>

<script>
// Variables globales
const uploadInput = document.getElementById('upload');
const imageContainer = document.getElementById('image-container');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const imageElement = document.getElementById('image');
const colorInfo = document.getElementById('color-info');
const pickedColorDiv = document.getElementById('picked-color');
const hexText = document.getElementById('hex');
const rgbText = document.getElementById('rgb');
const hslText = document.getElementById('hsl');
const paletteDiv = document.getElementById('palette');

uploadInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    imageElement.src = event.target.result;
    imageElement.onload = () => {
      // Tamaño natural de la imagen
      const naturalWidth = imageElement.naturalWidth;
      const naturalHeight = imageElement.naturalHeight;

      // Máximo ancho visible
      const maxDisplayWidth = 500;

      // Calculamos escala para que se ajuste al max ancho sin perder proporción
      let displayWidth = naturalWidth;
      let displayHeight = naturalHeight;

      if (naturalWidth > maxDisplayWidth) {
        displayWidth = maxDisplayWidth;
        displayHeight = (naturalHeight / naturalWidth) * maxDisplayWidth;
      }

      // Ajustar canvas tamaño interno a la imagen real
      canvas.width = naturalWidth;
      canvas.height = naturalHeight;

      // Ajustar tamaño CSS para que se vea escalada en el contenedor
      canvas.style.width = displayWidth + 'px';
      canvas.style.height = displayHeight + 'px';

      // Mostrar contenedor
      imageContainer.style.display = 'block';
      colorInfo.style.display = 'block';

      // Dibujar imagen en canvas en tamaño real
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(imageElement, 0, 0);

      // Extraer paleta
      const palette = getDominantColors(ctx, canvas.width, canvas.height, 5);
      renderPalette(palette);

      // No mostrar el <img>
      imageElement.style.display = 'none';
    };
  };
  reader.readAsDataURL(file);
});

// Ajustar posición clic para considerar el escalado del canvas
canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  // Coordenadas relativas en el canvas visible
  const x_display = e.clientX - rect.left;
  const y_display = e.clientY - rect.top;

  // Relación de escala entre canvas real y mostrado
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;

  // Coordenadas reales en la imagen original
  const x = Math.floor(x_display * scaleX);
  const y = Math.floor(y_display * scaleY);

  const pixel = ctx.getImageData(x, y, 1, 1).data;
  const [r, g, b, a] = pixel;

  if(a === 0) {
    alert("El píxel es transparente. Selecciona otra área.");
    return;
  }

  const hex = rgbToHex(r, g, b);
  const rgb = `rgb(${r}, ${g}, ${b})`;
  const hsl = rgbToHsl(r, g, b);

  pickedColorDiv.style.backgroundColor = hex;
  hexText.textContent = `HEX: ${hex}`;
  rgbText.textContent = `RGB: ${rgb}`;
  hslText.textContent = `HSL: ${hsl}`;
});

// Función para convertir RGB a HEX
function rgbToHex(r, g, b) {
  return "#" + [r, g, b].map(x => {
    const hex = x.toString(16);
    return hex.length === 1 ? "0" + hex : hex;
  }).join('');
}

// Función para convertir RGB a HSL
function rgbToHsl(r, g, b) {
  r /= 255; g /= 255; b /= 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;

  if(max === min) h = s = 0; // gris
  else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch(max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h /= 6;
  }
  h = Math.round(h * 360);
  s = Math.round(s * 100);
  l = Math.round(l * 100);
  return `hsl(${h}, ${s}%, ${l}%)`;
}

// Función para extraer colores dominantes
function getDominantColors(ctx, width, height, count) {
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  const pixels = [];

  // Muestreamos píxeles para acelerar (cada 10 pixeles)
  const step = 10;
  for(let y = 0; y < height; y += step) {
    for(let x = 0; x < width; x += step) {
      const i = (y * width + x) * 4;
      const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
      if(a > 200) // ignorar transparentes
        pixels.push([r,g,b]);
    }
  }

  // K-means simple con count clusters
  let clusters = [];
  for(let i=0; i<count; i++) {
    clusters.push(pixels[Math.floor(Math.random()*pixels.length)]);
  }

  let iterations = 8;
  while(iterations--) {
    let groups = Array(count).fill().map(()=>[]);
    for(let p of pixels) {
      let distances = clusters.map(c => colorDistance(p, c));
      let minIndex = distances.indexOf(Math.min(...distances));
      groups[minIndex].push(p);
    }
    for(let i=0; i<count; i++) {
      if(groups[i].length === 0) continue;
      clusters[i] = averageColor(groups[i]);
    }
  }
  return clusters.map(c => rgbToHex(Math.round(c[0]), Math.round(c[1]), Math.round(c[2])));
}

function colorDistance(c1, c2) {
  return Math.sqrt(
    (c1[0]-c2[0])**2 + 
    (c1[1]-c2[1])**2 + 
    (c1[2]-c2[2])**2
  );
}

function averageColor(colors) {
  const total = colors.length;
  const avg = colors.reduce((acc, c) => {
    acc[0]+= c[0];
    acc[1]+= c[1];
    acc[2]+= c[2];
    return acc;
  }, [0,0,0]);
  return avg.map(x => x/total);
}

// Renderizar paleta en el DOM
function renderPalette(colors) {
  paletteDiv.innerHTML = "";
  colors.forEach(hex => {
    const div = document.createElement('div');
    div.className = 'palette-color';
    div.style.backgroundColor = hex;
    div.title = hex;
    paletteDiv.appendChild(div);
  });
}
</script>

</body>
</html>
